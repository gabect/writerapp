<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Writer â€” Minimal</title>
  <style>
    :root{
      --bg: #0b0c10;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: #e9eef5;
      --muted: rgba(255,255,255,.70);
      --paper: #f7f1e3;
      --ink: #1a1a1a;
      --line: rgba(0,0,0,.06);
      --accent: rgba(255,255,255,.35);
      --cursor: rgba(255,255,255,.85);
      --shadow: rgba(0,0,0,.55);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
      --radius: 14px;
  --select-bg: #ffffff;
  --select-text: #111111;
    }

    /* ===== Themes (by data-theme) ===== */
    html[data-theme="dark"]{
      --bg:#0b0c10; --text:#e9eef5; --muted:rgba(255,255,255,.70);
      --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.10);
      --accent:rgba(255,255,255,.35); --cursor:rgba(255,255,255,.85);
      --shadow:rgba(0,0,0,.55);
    }
    html[data-theme="day"]{
      --bg:#eceff3; --text:#111319; --muted:rgba(0,0,0,.60);
      --panel:rgba(0,0,0,.06); --panel2:rgba(0,0,0,.10);
      --accent:rgba(0,0,0,.25); --cursor:rgba(0,0,0,.75);
      --shadow:rgba(0,0,0,.20);
    }
    html[data-theme="matrix"]{
      --bg:#020403; --text:#77ff9a; --muted:rgba(119,255,154,.70);
      --panel:rgba(119,255,154,.08); --panel2:rgba(119,255,154,.14);
      --accent:rgba(119,255,154,.35); --cursor:rgba(119,255,154,.95);
      --shadow:rgba(0,0,0,.70);
    }
    html[data-theme="paper"]{
      --bg:#dbd3c4; --text:var(--ink); --muted:rgba(0,0,0,.60);
      --panel:rgba(0,0,0,.06); --panel2:rgba(0,0,0,.10);
      --accent:rgba(0,0,0,.20); --cursor:rgba(0,0,0,.78);
      --shadow:rgba(0,0,0,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
    }

html[data-theme="dark"]{
  --select-bg: #1a1a1a;
  --select-text: #f0f0f0;
}
html[data-theme="day"]{
  --select-bg: #ffffff;
  --select-text: #111111;
}
html[data-theme="matrix"]{
  --select-bg: #031a0a;
  --select-text: #77ff9a;
}
html[data-theme="paper"]{
  --select-bg: #f7f1e3;
  --select-text: #1a1a1a;
}


    /* ===== Minimal layout ===== */
    .topbar{
      position:fixed; left:12px; right:12px; top:12px;
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      background: var(--panel);
      border:1px solid var(--panel2);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      z-index:10;
    }
    .left{flex:1; min-width:0; display:flex; gap:10px; align-items:center}
    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    .btn, select, input[type="text"]{
      border:1px solid var(--panel2);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding:8px 10px;
      font-size:13px;
      outline:none;
    }
    html[data-theme="day"] .btn,
    html[data-theme="day"] select,
    html[data-theme="day"] input[type="text"]{
      background: rgba(255,255,255,.55);
    }

    .btn{cursor:pointer; user-select:none}
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color: rgba(80,220,140,.45)}
    .btn.danger{border-color: rgba(255,80,80,.35)}

    select{min-width: 220px; max-width: 52vw}
    .status{
      display:flex; align-items:center; gap:8px;
      color: var(--muted); font-size:12px; white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%; background: rgba(160,160,160,.55)}
    .status.saved .dot{background: rgba(80,220,140,.85)}
    .status.pending .dot{background: rgba(255,190,80,.85)}
    .status.error .dot{background: rgba(255,80,80,.85)}

    .stage{
      height:100%;
      padding: 78px 18px 18px;
      display:flex;
      justify-content:center;
      align-items:stretch;
    }

select option{
  background-color: var(--select-bg);
  color: var(--select-text);
}


    /* ===== Writing surface ===== */
    .page{
      width: min(920px, 96vw);
      height: 100%;
      border-radius: 18px;
      border: 1px solid var(--panel2);
      background: var(--panel);
      box-shadow: 0 22px 34px var(--shadow);
      position:relative;
      overflow:hidden;
    }

    /* Paper theme adds real paper lines */
    html[data-theme="paper"] .page{
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,0) 0px,
          rgba(0,0,0,0) 27px,
          var(--line) 28px
        ),
        var(--paper);
      border-color: rgba(0,0,0,.12);
    }

    .editor{
      position:absolute;
      inset: 18px 18px;
      padding: 18px 18px 30px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 18px;
      line-height: 28px;
      letter-spacing: .15px;
      outline:none;
      caret-color: transparent; /* we draw our own caret */
      color: var(--text);
    }
    html[data-theme="paper"] .editor{
      color: var(--ink);
    }
    /* Minimal formatting */
    .editor h1{font-size:28px; line-height:38px; margin: 16px 0 10px}
    .editor h2{font-size:22px; line-height:32px; margin: 14px 0 8px}
    .editor p{margin:0 0 10px}
    .editor blockquote{
      margin: 10px 0;
      padding: 10px 12px;
      border-left: 4px solid var(--accent);
      background: rgba(0,0,0,.05);
      border-radius: 12px;
    }

    /* ===== Blinking caret ===== */
    .caret{
      position:absolute;
      width: 10px;
      height: 24px;
      background: var(--cursor);
      border-radius: 2px;
      pointer-events:none;
      animation: blink 1.08s steps(1) infinite;
      transform: translate(-9999px, -9999px);
      z-index:5;
    }
    @keyframes blink{50%{opacity:0}}

    /* ===== Small help tooltip (minimal, optional) ===== */
    .hint{
      position:fixed;
      bottom:12px; left:12px;
      padding:10px 12px;
      border-radius: 12px;
      background: var(--panel);
      border:1px solid var(--panel2);
      color: var(--muted);
      font-size:12px;
      z-index:10;
      user-select:none;
    }
    .hint kbd{
      font-family: var(--mono);
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--panel2);
      background: rgba(255,255,255,.04);
      color: inherit;
    }
    @media(max-width:700px){
      .hint{display:none}
      select{min-width: 160px}
      .editor{font-size:16px; line-height:26px}
    }
  </style>
</head>
<body>

  <div class="topbar" role="toolbar" aria-label="Writer controls">
    <div class="left">
      <button class="btn primary" id="newBtn">+ Nuevo</button>
      <select id="docSelect" aria-label="Documentos"></select>
      <span class="status saved" id="status"><span class="dot"></span><span id="statusText">Listo</span></span>
    </div>

    <div class="right">
      <select id="themeSelect" aria-label="Tema">
        <option value="dark">Oscuro</option>
        <option value="day">DÃ­a</option>
        <option value="matrix">Matrix</option>
        <option value="paper">Papel & tinta</option>
      </select>
<button class="btn" id="soundBtn" title="Sonido on/off">ðŸ”Š</button>

      <button class="btn" id="renameBtn">Renombrar</button>
      <button class="btn danger" id="deleteBtn">Borrar</button>
      <button class="btn" id="exportBtn">Exportar</button>
      <button class="btn" id="importBtn">Importar</button>
      <input id="importFile" type="file" accept=".json,.html,.txt" hidden />
    </div>
  </div>

  <div class="stage">
    <div class="page" id="page">
      <div id="editor" class="editor" contenteditable="true" spellcheck="true"></div>
      <div id="caret" class="caret" aria-hidden="true"></div>
    </div>
  </div>

  <div class="hint" aria-hidden="true">
    Autosave en <kbd>Space</kbd> / <kbd>Enter</kbd> / <kbd>Tab</kbd> Â· Tema arriba Â· Docs mÃºltiples
  </div>

<script>
(() => {
  /* =========================
     Storage keys
  ========================= */
  const LS_DOCS   = "writer_min_docs_v1";
  const LS_ACTIVE = "writer_min_active_v1";
  const LS_PREFS  = "writer_min_prefs_v1";
const LS_SOUND = "writer_min_sound_v1";


  /* =========================
     DOM
  ========================= */
  const editor = document.getElementById("editor");
  const caret  = document.getElementById("caret");
  const docSelect = document.getElementById("docSelect");
  const themeSelect = document.getElementById("themeSelect");
  const statusEl = document.getElementById("status");
  const statusText = document.getElementById("statusText");

  const newBtn = document.getElementById("newBtn");
  const renameBtn = document.getElementById("renameBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const importFile = document.getElementById("importFile");


const soundBtn = document.getElementById("soundBtn");

function updateSoundBtn(){
  soundBtn.textContent = soundOn ? "ðŸ”Š" : "ðŸ”‡";
}

soundBtn.addEventListener("click", () => {
  soundOn = !soundOn;
  localStorage.setItem(LS_SOUND, JSON.stringify(soundOn));
  updateSoundBtn();
});

  /* =========================
     Helpers
  ========================= */
  const now = () => Date.now();
  const uid = () => "doc_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);

  const safeParse = (k, fallback) => {
    try { return JSON.parse(localStorage.getItem(k) || "") ?? fallback; }
    catch { return fallback; }
  };

  const setStatus = (kind, text) => {
    statusEl.classList.remove("saved","pending","error");
    statusEl.classList.add(kind);
    statusText.textContent = text;
  };

  const escapeHTML = (s) =>
    String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

  function placeCaretEnd(el){
    el.focus();
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }

  /* =========================
     Docs model
  ========================= */
  let docs = safeParse(LS_DOCS, {});
  let activeId = localStorage.getItem(LS_ACTIVE) || null;

  function ensureFirstDoc(){
    if(Object.keys(docs).length === 0){
      const id = uid();
      docs[id] = {
        id,
        title: "Documento 01",
        html: "<p>Escribe aquÃ­â€¦</p>",
        updatedAt: now()
      };
      localStorage.setItem(LS_DOCS, JSON.stringify(docs));
      activeId = id;
      localStorage.setItem(LS_ACTIVE, activeId);
    }
  }

  function sortedDocs(){
    return Object.values(docs).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  }

  function refreshDocSelect(){
    const list = sortedDocs();
    docSelect.innerHTML = "";
    for(const d of list){
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.title || "Sin tÃ­tulo";
      docSelect.appendChild(opt);
    }
    if(activeId && docs[activeId]) docSelect.value = activeId;
  }

  function loadDoc(id){
    if(!docs[id]) return;
    activeId = id;
    localStorage.setItem(LS_ACTIVE, activeId);
    editor.innerHTML = docs[id].html || "<p></p>";
    refreshDocSelect();
    setStatus("saved","Listo");
    placeCaretEnd(editor);
    requestAnimationFrame(updateCaret);
  }

  function currentDoc(){
    return docs[activeId] || null;
  }

  /* =========================
     Autosave rules
     - save immediately on Space / Enter / Tab
     - "safety save" after idle (prevents loss without breaking your rule)
  ========================= */
  let dirty = false;
  let safetyTimer = null;

  function markDirty(){
    dirty = true;
    setStatus("pending","Pendienteâ€¦");
  }

  function saveNow(reason){
    const d = currentDoc();
    if(!d) return;
    d.html = editor.innerHTML;
    d.updatedAt = now();
    docs[d.id] = d;
    localStorage.setItem(LS_DOCS, JSON.stringify(docs));
    dirty = false;
    setStatus("saved", `Guardado (${reason})`);
    refreshDocSelect();
  }

  function scheduleSafetySave(){
    clearTimeout(safetyTimer);
    safetyTimer = setTimeout(() => {
      if(dirty) saveNow("auto");
    }, 900);
  }

  /* =========================
     Blinking caret overlay (faux caret)
  ========================= */
  function getCaretRect(){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount === 0) return null;

    const range = sel.getRangeAt(0).cloneRange();
    range.collapse(true);

    let rect = range.getBoundingClientRect();
    if(rect && rect.width === 0 && rect.height === 0){
      const span = document.createElement("span");
      span.textContent = "\u200b";
      range.insertNode(span);
      rect = span.getBoundingClientRect();
      span.remove();
      sel.removeAllRanges();
      sel.addRange(range);
    }
    return rect;
  }

  function updateCaret(){
    const rect = getCaretRect();
    if(!rect) return;
    const pageRect = document.getElementById("page").getBoundingClientRect();
    const x = rect.left - pageRect.left;
    const y = rect.top  - pageRect.top;
    caret.style.transform = `translate(${x}px, ${y}px) translate(-1px,-2px)`;
  }

  editor.addEventListener("click", updateCaret);
  editor.addEventListener("keyup", updateCaret);
  editor.addEventListener("scroll", updateCaret);
  window.addEventListener("resize", updateCaret);

  /* =========================
     Minimal type sound (optional feel)
     - No files, no dependencies
  ========================= */
  let audioCtx = null;
  function tickSound(){
    // deliberately subtle. If you hate it, comment out the call in keydown.
 if(!soundOn) return;
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state !== "running") audioCtx.resume().catch(()=>{});
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(950 + Math.random()*220, t);
    g.gain.setValueAtTime(0.08, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.035);
    o.connect(g).connect(audioCtx.destination);
    o.start(t);
    o.stop(t + 0.04);
  }

  /* =========================
     Key handling (save triggers)
  ========================= */
  editor.addEventListener("keydown", (e) => {
    // minimal sound: comment this line if you want pure silence
    tickSound();

    if(e.key === "Tab"){
      e.preventDefault();
      document.execCommand("insertText", false, "    ");
      markDirty();
      saveNow("tab");
      requestAnimationFrame(updateCaret);
      return;
    }

    if(e.key === " "){
      markDirty();
      saveNow("espacio");
      requestAnimationFrame(updateCaret);
      return;
    }

    if(e.key === "Enter"){
      markDirty();
      saveNow("enter");
      requestAnimationFrame(updateCaret);
      return;
    }

    // other keys: mark dirty + safety save
    if(e.key.length === 1 && !e.ctrlKey && !e.metaKey){
      markDirty();
      scheduleSafetySave();
      requestAnimationFrame(updateCaret);
    }

    if(e.key === "Backspace" || e.key === "Delete"){
      markDirty();
      scheduleSafetySave();
      requestAnimationFrame(updateCaret);
    }
  });

  editor.addEventListener("input", () => {
    markDirty();
    scheduleSafetySave();
    updateCaret();
  });

  /* =========================
     Theme
  ========================= */
  const prefs = safeParse(LS_PREFS, { theme: "dark" });
  function applyTheme(t){
    document.documentElement.dataset.theme = t;
    themeSelect.value = t;
    prefs.theme = t;
    localStorage.setItem(LS_PREFS, JSON.stringify(prefs));
    requestAnimationFrame(updateCaret);
  }
  themeSelect.addEventListener("change", () => applyTheme(themeSelect.value));

  /* =========================
     Doc actions
  ========================= */
  function promptName(msg, def=""){
    const v = prompt(msg, def);
    if(v === null) return null;
    return String(v).trim();
  }

  newBtn.addEventListener("click", () => {
    const name = promptName("Nombre del documento:", "Documento 01");
    if(name === null) return;
    const id = uid();
    docs[id] = { id, title: name || "Sin tÃ­tulo", html: "<p></p>", updatedAt: now() };
    localStorage.setItem(LS_DOCS, JSON.stringify(docs));
    loadDoc(id);
    saveNow("nuevo");
  });

  renameBtn.addEventListener("click", () => {
    const d = currentDoc();
    if(!d) return;
    const name = promptName("Nuevo nombre:", d.title || "");
    if(name === null) return;
    d.title = name || "Sin tÃ­tulo";
    d.updatedAt = now();
    docs[d.id] = d;
    localStorage.setItem(LS_DOCS, JSON.stringify(docs));
    refreshDocSelect();
    setStatus("saved","Renombrado");
  });

  deleteBtn.addEventListener("click", () => {
    const d = currentDoc();
    if(!d) return;
    const ok = prompt(`Escribe BORRAR para eliminar â€œ${d.title}â€:`, "");
    if(ok !== "BORRAR"){ setStatus("saved","Cancelado"); return; }
    delete docs[d.id];
    localStorage.setItem(LS_DOCS, JSON.stringify(docs));
    const list = sortedDocs();
    if(list.length === 0){
      ensureFirstDoc();
      refreshDocSelect();
      loadDoc(activeId);
    }else{
      loadDoc(list[0].id);
    }
    setStatus("saved","Borrado");
  });

  docSelect.addEventListener("change", () => {
    if(dirty) saveNow("cambio");
    loadDoc(docSelect.value);
  });

  /* =========================
     Export / Import
     - Export: JSON of all docs (safe backup)
     - Import: JSON restore
  ========================= */
  exportBtn.addEventListener("click", () => {
    if(dirty) saveNow("export");
    const payload = {
      app: "writer-min",
      version: 1,
      exportedAt: new Date().toISOString(),
      activeId,
      theme: document.documentElement.dataset.theme || "dark",
      docs
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "writer_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus("saved","Exportado");
  });

  importBtn.addEventListener("click", () => importFile.click());
  importFile.addEventListener("change", async () => {
    const f = importFile.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      if(f.name.toLowerCase().endsWith(".json")){
        const data = JSON.parse(txt);
        if(!data || !data.docs) throw new Error("Formato invÃ¡lido");
        docs = data.docs;
        localStorage.setItem(LS_DOCS, JSON.stringify(docs));
        if(data.theme) applyTheme(data.theme);
        const ids = Object.keys(docs);
        activeId = (data.activeId && docs[data.activeId]) ? data.activeId : ids[0];
        localStorage.setItem(LS_ACTIVE, activeId);
        refreshDocSelect();
        loadDoc(activeId);
        setStatus("saved","Importado");
      }else if(f.name.toLowerCase().endsWith(".txt")){
        const id = uid();
        const clean = txt.replace(/\r\n/g,"\n").trim();
        const html = clean
          ? clean.split(/\n\s*\n/g).map(p=>`<p>${escapeHTML(p).replace(/\n/g,"<br>")}</p>`).join("")
          : "<p></p>";
        docs[id] = { id, title: f.name.replace(/\.(txt|html)$/i,""), html, updatedAt: now() };
        localStorage.setItem(LS_DOCS, JSON.stringify(docs));
        loadDoc(id);
        saveNow("import txt");
      }else{
        // html: import body
        const bodyMatch = txt.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
        const html = (bodyMatch ? bodyMatch[1] : txt).trim() || "<p></p>";
        const id = uid();
        docs[id] = { id, title: f.name.replace(/\.(txt|html)$/i,""), html, updatedAt: now() };
        localStorage.setItem(LS_DOCS, JSON.stringify(docs));
        loadDoc(id);
        saveNow("import html");
      }
    }catch(e){
      setStatus("error","Import fallÃ³");
    }finally{
      importFile.value = "";
    }
  });

  /* =========================
     Boot
  ========================= */
let soundOn = JSON.parse(localStorage.getItem(LS_SOUND) ?? "true");

  ensureFirstDoc();
  refreshDocSelect();
  if(!activeId || !docs[activeId]){
    activeId = sortedDocs()[0].id;
    localStorage.setItem(LS_ACTIVE, activeId);
  }
  applyTheme(prefs.theme || "dark");
  loadDoc(activeId);
  requestAnimationFrame(updateCaret);
})();

updateSoundBtn();

</script>
</body>
</html>
